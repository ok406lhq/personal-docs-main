---

---

# ANTLRï¼šä»è¯­æ³•è§„åˆ™åˆ°ä»£ç ç”Ÿæˆ

> ä»Šå¤©å‘¨äº”ï¼Œæœ€è¿‘åœ¨å¿™å…¶ä»–äº‹æƒ…ï¼Œæœ‰ä¸€æ®µæ—¶é—´æ²¡å†™åšå®¢äº†ï¼Œæ‰“å¼€ç¼–è¾‘å™¨ï¼Œæƒ³è®°å½•ä¸€ä¸‹å…³äºantlrè¿™ä¸ªåŠŸèƒ½å¼ºå¤§çš„ è¯­æ³•åˆ†æå™¨ç”Ÿæˆå™¨ã€‚

## ANTLRæ˜¯ä»€ä¹ˆ

é¦–å…ˆä»‹ç»ä¸€ä¸‹ANTLRï¼Œå…¶å…¨ç§° Another Tool for Language Recognitionï¼Œæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ è¯­æ³•åˆ†æå™¨ç”Ÿæˆå™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯æ ¹æ®ä½ å®šä¹‰çš„ä¸€å¥— è¯­æ³•è§„åˆ™ï¼ˆGrammarï¼‰ï¼Œè‡ªåŠ¨ç”Ÿæˆç”¨äº è¯æ³•åˆ†æï¼ˆLexerï¼‰ å’Œ è¯­æ³•åˆ†æï¼ˆParserï¼‰ çš„ Javaã€Pythonã€C++ ç­‰è¯­è¨€ä»£ç ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œä½ å‘Šè¯‰ANTLRè¦è¯†åˆ«ä»€ä¹ˆè§„åˆ™çš„ç»“æ„
ï¼Œå…¶ä¾¿ä¼šå¸®ä½ æ„å»ºå‡ºå¯¹åº”çš„Tokenï¼ˆLexerï¼‰ï¼Œè¯­æ³•æ ‘ï¼ˆParseï¼‰ï¼Œå¹¶é€šè¿‡ç›‘å¬è€…æ¨¡å¼ï¼ˆListenerï¼‰ or è®¿é—®è€…æ¨¡å¼ï¼ˆVisitorï¼‰æ— ä¾µå…¥çš„å¯¹è¯­æ³•æ ‘å±€éƒ¨è¿›è¡Œå®šåˆ¶åŒ–æ“ä½œï¼Œè€Œä¸ç”¨å…³å¿ƒæ•´ä¸ªè¯æ³•ã€è¯­æ³•æ ‘çš„æ„å»ºä¸è®¿é—®ç­‰æƒ…å†µã€‚

**å…³äºè¯æ³•å’Œè¯­æ³•ã€è¯­ä¹‰ç­‰çŸ¥è¯†æ¦‚å¿µï¼Œå¯ä»¥å»å­¦ä¹ ä¸€ä¸‹ç¼–è¯‘åŸç†ç›¸å…³çŸ¥è¯†è¿›è¡Œè¡¥å……äº†è§£ï¼Œç¬”è€…è™½ç„¶å¤§å­¦çš„æ—¶å€™ç¼–è¯‘åŸç†è¿™ä¸€é—¨è¯¾å­¦å¾—è¿˜è¡Œï¼Œä¹Ÿå†™è¿‡è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æåˆ°æœ€ç»ˆè§£é‡Šå™¨çš„ä»£ç ï¼Œä½†æ˜¯æ—¶é—´ä¸€ä¹…ï¼Œç›¸å…³å†…å®¹ä¹Ÿå¿˜äº†ä¸å°‘ï¼Œè€Œä¸”è¿™é—¨è¯¾ç¨‹ç¡®å®ä¹Ÿå¾ˆéš¾ï¼Œå€¼å¾—ä¸”éœ€è¦èŠ±è´¹æ—¶é—´ä¸ç²¾åŠ›å»å­¦æ ¡**

## é€‚ç”¨åœºæ™¯

- ğŸŒ è‡ªå®šä¹‰è¯­è¨€æˆ– DSL çš„è§£æå™¨ï¼ˆå¦‚ SQL æ–¹è¨€ã€è„šæœ¬è¯­è¨€ç­‰ï¼‰

- ğŸ› ï¸ é™æ€ä»£ç åˆ†æå·¥å…·ï¼ˆæ¯”å¦‚ä»£ç è´¨é‡æ£€æŸ¥å™¨ï¼‰

- ğŸ§  ç¼–è¯‘å™¨å‰ç«¯ï¼ˆè¯­æ³•åˆ†æå™¨ï¼‰

- ğŸ“š å­¦ä¹ è¯­è¨€æ„é€ å’Œç¼–è¯‘åŸç†

- ğŸ“ é…ç½®æ–‡ä»¶è§£æï¼ˆå¦‚è‡ªå®šä¹‰è§„åˆ™è¯­è¨€ï¼‰

## èƒŒæ™¯

åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œæœ‰è®¸å¤šç”¨åˆ°é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDSLï¼‰ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰è¡¨è¾¾å¼è§£æè®¡ç®—ç­‰éœ€æ±‚ã€‚ä½†åœ¨è€é¡¹ç›®éšç€åŠŸèƒ½éœ€æ±‚çš„ä¸æ–­è¿­ä»£ï¼Œä¸šåŠ¡å¤æ‚åº¦ä¸æ–­æé«˜ã€‚åŸæœ‰çš„æ–¹æ¡ˆå·²ç»ä¸æ»¡è¶³ç°æœ‰çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œéœ€è¦è®¿é—®æ·±å±‚åµŒå¥—çš„è¯­æ³•æ ‘çš„å±€éƒ¨èŠ‚ç‚¹åšç‰¹å®šå¤„ç†ï¼Œéœ€è¦åœ¨æ•´ä¸ªåˆ†æè¿‡ç¨‹ä¸­æ„å»ºè¯­æ³•æ ‘è¿›è¡Œå¤„ç†ä¸Šä¸‹æ–‡ç­‰ç­‰åœºæ™¯ã€‚å¦‚æœåœ¨åŸæœ‰çš„æ–¹æ¡ˆä¸Šå¼€å‘æˆæœ¬å’Œå¿ƒæ™ºè´Ÿæ‹…è¿‡äºæ²‰é‡ã€‚å› æ­¤ï¼Œé€‰æ‹©äº†é€šè¿‡ANTLRè‡ªå®šä¹‰è¯­æ³•è§„åˆ™è¿›è¡Œæ–¹æ¡ˆæ›¿æ¢ä¼˜åŒ–ã€‚

## ANTLR ç®€å•ä½¿ç”¨

### ANTLR çš„æ ¸å¿ƒç»„ä»¶

åœ¨ä½¿ç”¨ANTLRå‰ï¼Œå…ˆä»‹ç»ä¸€ä¸‹ANTLRç›¸å…³çš„å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µæ¥ç»„ç»‡è¯­æ³•å’Œç”Ÿæˆä»£ç ï¼š

| ç»„ä»¶               | è¯´æ˜                      |
| ---------------- | ----------------------- |
| `.g4` æ–‡ä»¶         | ANTLR çš„è¯­æ³•è§„åˆ™æ–‡ä»¶ï¼Œå®šä¹‰è¯­æ³•ç»“æ„    |
| Lexerï¼ˆè¯æ³•åˆ†æå™¨ï¼‰     | å°†å­—ç¬¦æµæ‹†è§£æˆ **Token** æµ     |
| Parserï¼ˆè¯­æ³•åˆ†æå™¨ï¼‰    | æ ¹æ®è¯­æ³•è§„åˆ™ç»„ç»‡ Tokenï¼Œæ„é€ è¯­æ³•æ ‘    |
| Visitor/Listener | å¯¹è¯­æ³•æ ‘è¿›è¡Œéå†ï¼Œåšè¯­ä¹‰åˆ†æã€æ‰§è¡Œã€ä»£ç ç”Ÿæˆç­‰ |

### ä¸€ä¸ªç®€å•çš„è¡¨è¾¾å¼è¯­æ³•ä¾‹å­

å› æ­¤ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª*.g4çš„è¯­æ³•è§„åˆ™æ–‡ä»¶ï¼Œå®šä¹‰è¯æ³•å’Œè¯­æ³•è§„åˆ™ï¼ˆå®é™…ç”Ÿäº§ä¸­æ ¹æ®åœºæ™¯ï¼Œå¯ä»¥å°†è¯æ³•ä¸è¯­æ³•.g4æ–‡ä»¶æ‹†åˆ†æ¥è¿›è¡Œç»´æŠ¤ï¼Œé¿å…å†—ä½™ç­‰æƒ…å†µï¼Œä¾¿äºç»´æŠ¤ï¼‰ã€‚

ä¸‹é¢ä¾¿åˆ›å»ºä¸€ä¸ªæ”¯æŒ + å’Œ * è¿ç®—çš„ç®€å•è®¡ç®—å™¨ã€‚

```bash
grammar Expr;

expr: expr op=('*'|'/') expr      # MulDiv
    | expr op=('+'|'-') expr      # AddSub
    | INT                         # Int
    | '(' expr ')'                # Parens
    ;

INT: [0-9]+;
WS: [ \t\r\n]+ -> skip;
```

**è§£é‡Šï¼šexpr æ˜¯é€’å½’å®šä¹‰ï¼Œæ”¯æŒæ‹¬å·åµŒå¥—å’Œæ“ä½œç¬¦ä¼˜å…ˆçº§ã€‚æ¯ä¸ªè¯­æ³•è§„åˆ™ååŠ çš„ # Name æ˜¯â€œæ ‡ç­¾åâ€ï¼Œç”¨äº Visitor æ¨¡å¼ä¸­åŒºåˆ†å­èŠ‚ç‚¹ã€‚**

> å…·ä½“ä»¥åŠå…¶ä»–ç”¨æ³•å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£:https://github.com/antlr/antlr4/tree/master

### ä»è¯­æ³•åˆ°ä»£ç ï¼šä½¿ç”¨æµç¨‹

1. å®‰è£… ANTLR å·¥å…·

```bash
brew install antlr # macOS
# or ä¸‹è½½ jarï¼šhttps://www.antlr.org/download.html
```

å¦‚æœä¹ æƒ¯ä½¿ç”¨ideaçš„æœ‹å‹å¯ä»¥åœ¨idaeä¸Šå®‰è£…å¯¹åº”æ’ä»¶ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

2. ç”Ÿæˆä»£ç 

```bash
antlr4 Expr.g4 -visitor -package com.example.expr
```

è¾“å‡ºåŒ…æ‹¬ä½†ä¸å±€é™äºä¸‹é¢çš„æ–‡ä»¶ï¼š
- ExprLexer.java
- ExprParser.java
- ExprBaseVisitor.java
- ExprVisitor.java

3.ç¼–å†™ Visitor è§£æè¡¨è¾¾å¼

```java
public class EvalVisitor extends ExprBaseVisitor<Integer> {
    @Override
    public Integer visitAddSub(ExprParser.AddSubContext ctx) {
        int left = visit(ctx.expr(0));
        int right = visit(ctx.expr(1));
        return ctx.op.getType() == ExprParser.PLUS ? left + right : left - right;
    }

    @Override
    public Integer visitMulDiv(ExprParser.MulDivContext ctx) {
        int left = visit(ctx.expr(0));
        int right = visit(ctx.expr(1));
        return ctx.op.getType() == ExprParser.MUL ? left * right : left / right;
    }

    @Override
    public Integer visitInt(ExprParser.IntContext ctx) {
        return Integer.parseInt(ctx.getText());
    }

    @Override
    public Integer visitParens(ExprParser.ParensContext ctx) {
        return visit(ctx.expr());
    }
}
```

4. æ‰§è¡Œå¹¶æµ‹è¯•

```java
ANTLRInputStream input = new ANTLRInputStream("2 * (3 + 4)");
ExprLexer lexer = new ExprLexer(input);
CommonTokenStream tokens = new CommonTokenStream(lexer);
ExprParser parser = new ExprParser(tokens);
ParseTree tree = parser.expr();

EvalVisitor visitor = new EvalVisitor();
System.out.println(visitor.visit(tree)); // è¾“å‡º 14
```

è‡³æ­¤ï¼Œä¸€ä¸ªç®€å•çš„è®¡ç®—è¡¨è¾¾å¼ä¾¿å¼€å‘å®Œæ¯•äº†ï¼ŒANTLRç»™æˆ‘ä»¬å°è£…å’Œå±è”½äº†æ•´ä¸ªè¯æ³•ï¼Œè¯­æ³•è§„åˆ™çš„æ„å»ºè¿‡ç¨‹ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºç¼–å†™è§„åˆ™æ–‡ä»¶ä»¥åŠæ ¹æ®éœ€æ±‚ä½¿ç”¨Listeneræˆ–Visitorå»è®¿é—®è¯­æ³•æ ‘å®ç°æˆ‘ä»¬çš„ä¸šåŠ¡è¯‰æ±‚å³å¯ã€‚

## å°ç»“

ä¸Šé¢åªæ˜¯ä¸€ä¸ªç®€å•çš„ä»‹ç»å’Œä¾‹å­ï¼Œå®é™…çš„å¼€å‘åœºæ™¯ä¸­ä¼šé‡åˆ°å¥‡å¥‡æ€ªæ€ªã€å„å¼å„æ ·çš„è¯‰æ±‚ï¼šå¯èƒ½éœ€è¦æ”¯æŒä¸Šä¸‹æ–‡æ•æ„Ÿè¯­æ³•ï¼Œå¯èƒ½éœ€è¦å¤„ç†ä¼˜é›…çš„é”™è¯¯æç¤ºï¼Œå¯èƒ½å¸Œæœ›å’Œå·²æœ‰é¡¹ç›®æ— ç¼é›†æˆï¼Œç”šè‡³è¿˜æœ‰äººæ‹¿å®ƒå†™ä»£ç è½¬æ¢ã€é‡å†™å™¨ã€ç”Ÿæˆå™¨â€¦â€¦ä½†ä¸ç®¡æ˜¯å“ªä¸€ç§ï¼Œç”¨ ANTLR çš„è¿‡ç¨‹æ€»ä¼šé€¼ç€ä½ ç›´é¢è¯­è¨€æœ¬è´¨çš„æ··ä¹±ä¸ç§©åºã€‚

è¶Šå¾€æ·±å¤„èµ°ï¼Œå°±è¶Šå‘ç°è¯­æ³•è¿™ä¸œè¥¿â€”â€”è¿œä¸åªæ˜¯â€œè§„åˆ™â€çš„å †ç Œã€‚å®ƒæ˜¯æŠ½è±¡ã€æ˜¯å¦¥åã€æ˜¯è¯•å›¾ç»™æ··ä¹±ä¸–ç•Œå¥—ä¸Šçš„ç»“æ„åŒ–â€œæ¡†â€ã€‚å½“ç«™åœ¨ä¸€æ£µè¯­æ³•æ ‘é¢å‰å‡è§†å®ƒçš„ç»“æ„æ—¶ï¼Œå¯èƒ½ä¼šçªç„¶æ„è¯†åˆ°ï¼šè¯­è¨€æœ¬èº«ï¼Œå°±æ˜¯æˆ‘ä»¬äººç±»æ€ç»´çš„ä¸€ç§æŠ˜å°„ã€‚

è€Œè¿™æ—¶ï¼Œå†è”æƒ³åˆ°å½“ä¸‹ç«çƒ­çš„äººå·¥æ™ºèƒ½ä¸è‡ªç„¶è¯­è¨€å¤„ç†ï¼Œå¾ˆå¤šé—®é¢˜ä¼¼ä¹ä¹Ÿä¸å†åªæ˜¯æŠ€æœ¯æ€§çš„ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬è¯•å›¾è®©æœºå™¨ç†è§£äººç±»è¯­è¨€ï¼Œè€Œ ANTLR åˆ™æ˜¯åœ¨æ›´åº•å±‚ï¼Œå¸®æˆ‘ä»¬å®šä¹‰â€œä»€ä¹ˆæ‰ç®—æ˜¯ä¸€é—¨è¯­è¨€â€ã€‚

å½“ç„¶ï¼Œæœ€åæˆ‘æƒ³å†™çš„æ˜¯ï¼šANTLR ç»™äº†æˆ‘ä»¬ä¸€ç§å¯èƒ½ï¼Œä½†å¹¶æ²¡æœ‰å‘Šè¯‰æˆ‘ä»¬å“ªç§æ–¹å¼ä¸€å®šæ˜¯â€œå¯¹â€çš„ï¼Œä¹Ÿæ²¡å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™è¯¥åœä¸‹ï¼Œä»€ä¹ˆæ—¶å€™è¯¥ç»§ç»­æ‹†åˆ†ä¸ç»„åˆã€‚å®ƒåªæä¾›äº†ä¸€ä¸ªå·¥å…·ï¼Œè€Œä¸æ˜¯ç­”æ¡ˆã€‚å› åœ°åˆ¶å®œï¼Œé€‚é…è‡ªå·±çš„è¯‰æ±‚ï¼Œæˆ–è®¸æ‰æ˜¯æœ€ä½³å®è·µã€‚å¯ä»¥å†™ä¸€ä¸ªä¼˜é›…çš„ DSLï¼Œä¹Ÿå¯ä»¥åšä¸€ä¸ªç²—ç³™ä½†å¯ç”¨çš„è¯­æ³•è¯†åˆ«å™¨ï¼›å¯ä»¥æ·±å…¥è¯­è¨€ç»“æ„ï¼Œä¹Ÿå¯ä»¥æµ…å°è¾„æ­¢ã€‚è¿™æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œåªæœ‰å½“ä¸‹æœ€é€‚åˆçš„æ–¹æ¡ˆã€‚


